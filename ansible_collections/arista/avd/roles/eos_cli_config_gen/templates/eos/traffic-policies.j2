{% if traffic_policies is arista.avd.defined %}
!
traffic-policies
{# FIELD SET #}
{#     -- IPv4 PREFIX MANAGEMENT -- #}
{%     if traffic_policies.field_sets.ipv4 is arista.avd.defined %}
{%         for field_set_ipv4 in traffic_policies.field_sets.ipv4 %}
   field-set ipv4 prefix {{ field_set_ipv4 }}
      {% for prefix in traffic_policies.field_sets.ipv4[field_set_ipv4] %}{{prefix}} {% endfor %}

   !
{%         endfor %}
{%     endif %}
{#     -- IPv6 PREFIX MANAGEMENT -- #}
{%     if traffic_policies.field_sets.ipv6 is arista.avd.defined %}
{%         for field_set_ipv6 in traffic_policies.field_sets.ipv6 %}
   field-set ipv6 prefix {{ field_set_ipv6 }}
      {% for prefix in traffic_policies.field_sets.ipv6[field_set_ipv6] %}{{prefix}} {% endfor %}

   !
{%         endfor %}
{%     endif %}
{#     -- L4 PORT MANAGEMENT -- #}
{%     if traffic_policies.field_sets.ports is arista.avd.defined %}
{%         for field_set_port in traffic_policies.field_sets.ports %}
   field-set l4-port {{ field_set_port }}
      {{ traffic_policies.field_sets.ports[field_set_port] }}
   !
{%         endfor %}
{%     endif %}
{# TRAFFIC POLICIES #}
{%     if traffic_policies.policies is arista.avd.defined %}
{%         for policy in traffic_policies.policies %}
   traffic-policy {{ policy }}
{%              if traffic_policies.policies[policy].matchs is arista.avd.defined %}
{# MATCH SECTION #}
{%              for match in traffic_policies.policies[policy].matchs %}
      match {{ match }} {{ traffic_policies.policies[policy].matchs[match].type | lower }}
{#                     -- SOURCE PREFIX MANAGEMENT -- #}
{%                   if traffic_policies.policies[policy].matchs[match].source is arista.avd.defined %}
{%                        if traffic_policies.policies[policy].matchs[match].source.prefixes is arista.avd.defined %}
         source prefix{% for prefix in traffic_policies.policies[policy].matchs[match].source.prefixes %} {{ prefix }}{% endfor %}

{%                         endif %}
{%                         if traffic_policies.policies[policy].matchs[match].source.prefix_lists is arista.avd.defined %}
         source prefix field-set{% for prefix in traffic_policies.policies[policy].matchs[match].source.prefix_lists %} {{ prefix }}{% endfor %}

{%                         endif %}
{%                     endif %}
{#                     -- DESTINATION PREFIX MANAGEMENT -- #}
{%                   if traffic_policies.policies[policy].matchs[match].destination is arista.avd.defined %}
{%                        if traffic_policies.policies[policy].matchs[match].destination.prefixes is arista.avd.defined %}
         source prefix{% for prefix in traffic_policies.policies[policy].matchs[match].destination.prefixes %} {{ prefix }}{% endfor %}

{%                         endif %}
{%                         if traffic_policies.policies[policy].matchs[match].destination.prefix_lists is arista.avd.defined %}
         source prefix field-set{% for prefix in traffic_policies.policies[policy].matchs[match].destination.prefix_lists %} {{ prefix }}{% endfor %}

{%                         endif %}
{%                     endif %}
{#                     -- PROTOCOL MANAGEMENT -- #}
{%                     if traffic_policies.policies[policy].matchs[match].protocols is arista.avd.defined %}
{%                         for protocol in traffic_policies.policies[policy].matchs[match].protocols %}
{#                             -- destination port-list -- #}
{%                             if traffic_policies.policies[policy].matchs[match].protocols[protocol].dst_port is arista.avd.defined %}
         protocol {{ protocol }} destination port {{ traffic_policies.policies[policy].matchs[match].protocols[protocol].dst_port }}
{#                             -- source port-list -- #}
{%                             elif traffic_policies.policies[policy].matchs[match].protocols[protocol].src_port is arista.avd.defined %}
         protocol {{ protocol }} source port {{ traffic_policies.policies[policy].matchs[match].protocols[protocol].src_port }}
{#                             -- destination field-set -- #}
{%                             elif traffic_policies.policies[policy].matchs[match].protocols[protocol].dst_field is arista.avd.defined %}
         protocol {{ protocol }} destination port field-set {{ traffic_policies.policies[policy].matchs[match].protocols[protocol].dst_field }}
{#                             -- source field-set -- #}
{%                             elif traffic_policies.policies[policy].matchs[match].protocols[protocol].src_field is arista.avd.defined %}
         protocol {{ protocol }} source port field-set {{ traffic_policies.policies[policy].matchs[match].protocols[protocol].src_field }}
{%                             else %}
         protocol {{ protocol }}
{%                             endif %}
{%                         endfor %}
{%                     endif %}
{#       -- ACTIONS SECTION -- #}
         actions
{#                     -- COUNT packets -- #}
{%                     if traffic_policies.policies[policy].matchs[match].actions.count is arista.avd.defined %}
            count {{ traffic_policies.policies[policy].matchs[match].actions.count }}
{%                     endif %}
{#                     -- Traffic Class -- #}
{%                     if traffic_policies.policies[policy].matchs[match].actions.traffic_class is arista.avd.defined %}
            set traffic class {{ traffic_policies.policies[policy].matchs[match].actions.traffic_class }}
{%                     endif %}
{#                     -- DSCP -- #}
{%                     if traffic_policies.policies[policy].matchs[match].actions.dscp is arista.avd.defined %}
            set dscp {{ traffic_policies.policies[policy].matchs[match].actions.dscp }}
{%                     endif %}
{#                     -- DROP Action -- #}
{%                     if traffic_policies.policies[policy].matchs[match].actions.drop is arista.avd.defined(true) %}
            drop
{#                         -- LOGGING only if DROP is set-- #}
{%                         if traffic_policies.policies[policy].matchs[match].actions.log is arista.avd.defined(true) %}
            log
{%                         endif %}
{%                     endif %}
{# END OF MATCH Section #}
         !
      !
{%                 endfor %}
{%             endif %}
   !
{%         endfor %}
{% endif %}
{% endif %}